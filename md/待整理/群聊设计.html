<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>群聊设计 | My vuepress</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/favicon.ico">
    <script src="https://hm.baidu.com/hm.js?xxxxxxxxxxx"></script>
    <meta name="description" content="Todo">
    <meta name="robots" content="all">
    <meta name="author" content="pdai">
    <meta name="keywords" content="Java 全栈知识体系, java体系, java知识体系, java框架,java详解,java学习路线,java spring, java面试, 知识体系, java技术体系, java编程, java编程指南,java开发体系, java开发,java教程,java,java数据结构, 算法, 开发基础">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="preload" href="/assets/css/0.styles.144ea653.css" as="style"><link rel="preload" href="/assets/js/app.afcd353c.js" as="script"><link rel="preload" href="/assets/js/2.6527dd7c.js" as="script"><link rel="preload" href="/assets/js/75.2f6086aa.js" as="script"><link rel="prefetch" href="/assets/js/10.b8af9589.js"><link rel="prefetch" href="/assets/js/11.da070787.js"><link rel="prefetch" href="/assets/js/12.e8c2df3f.js"><link rel="prefetch" href="/assets/js/13.13f8690b.js"><link rel="prefetch" href="/assets/js/14.97d7a7c6.js"><link rel="prefetch" href="/assets/js/15.ca82dd18.js"><link rel="prefetch" href="/assets/js/16.0795663b.js"><link rel="prefetch" href="/assets/js/17.9f529ede.js"><link rel="prefetch" href="/assets/js/18.aa494d1d.js"><link rel="prefetch" href="/assets/js/19.c5e368a6.js"><link rel="prefetch" href="/assets/js/20.8486962d.js"><link rel="prefetch" href="/assets/js/21.1a96e733.js"><link rel="prefetch" href="/assets/js/22.5b4929c3.js"><link rel="prefetch" href="/assets/js/23.7bc228ce.js"><link rel="prefetch" href="/assets/js/24.63116242.js"><link rel="prefetch" href="/assets/js/25.e9163e8b.js"><link rel="prefetch" href="/assets/js/26.31132baf.js"><link rel="prefetch" href="/assets/js/27.728265df.js"><link rel="prefetch" href="/assets/js/28.4cb93316.js"><link rel="prefetch" href="/assets/js/29.30a99cb0.js"><link rel="prefetch" href="/assets/js/3.e3c760c5.js"><link rel="prefetch" href="/assets/js/30.39c64819.js"><link rel="prefetch" href="/assets/js/31.78e9d272.js"><link rel="prefetch" href="/assets/js/32.e71f2609.js"><link rel="prefetch" href="/assets/js/33.b182a570.js"><link rel="prefetch" href="/assets/js/34.d919b2af.js"><link rel="prefetch" href="/assets/js/35.e2cdb183.js"><link rel="prefetch" href="/assets/js/36.759e107d.js"><link rel="prefetch" href="/assets/js/37.a0ccb526.js"><link rel="prefetch" href="/assets/js/38.8f8ec90d.js"><link rel="prefetch" href="/assets/js/39.bcb56569.js"><link rel="prefetch" href="/assets/js/4.e1e5a770.js"><link rel="prefetch" href="/assets/js/40.cb9e68d1.js"><link rel="prefetch" href="/assets/js/41.f7324d34.js"><link rel="prefetch" href="/assets/js/42.fbc4875e.js"><link rel="prefetch" href="/assets/js/43.602efb90.js"><link rel="prefetch" href="/assets/js/44.5cdea7dd.js"><link rel="prefetch" href="/assets/js/45.08b55f16.js"><link rel="prefetch" href="/assets/js/46.89b660d7.js"><link rel="prefetch" href="/assets/js/47.8041c4a7.js"><link rel="prefetch" href="/assets/js/48.54a6e067.js"><link rel="prefetch" href="/assets/js/49.63fc5fb5.js"><link rel="prefetch" href="/assets/js/5.b9a4a83e.js"><link rel="prefetch" href="/assets/js/50.defc28ad.js"><link rel="prefetch" href="/assets/js/51.01fa48a2.js"><link rel="prefetch" href="/assets/js/52.04cb5e30.js"><link rel="prefetch" href="/assets/js/53.b04e4c27.js"><link rel="prefetch" href="/assets/js/54.a99c8dca.js"><link rel="prefetch" href="/assets/js/55.f15500bf.js"><link rel="prefetch" href="/assets/js/56.c9d0f497.js"><link rel="prefetch" href="/assets/js/57.eb7e4183.js"><link rel="prefetch" href="/assets/js/58.4a5207ff.js"><link rel="prefetch" href="/assets/js/59.8620aeb6.js"><link rel="prefetch" href="/assets/js/6.ddfdb723.js"><link rel="prefetch" href="/assets/js/60.a1b1dae5.js"><link rel="prefetch" href="/assets/js/61.e6ec84e2.js"><link rel="prefetch" href="/assets/js/62.8703dde9.js"><link rel="prefetch" href="/assets/js/63.76d6c8fe.js"><link rel="prefetch" href="/assets/js/64.1abf1796.js"><link rel="prefetch" href="/assets/js/65.7430076b.js"><link rel="prefetch" href="/assets/js/66.9ca1a22b.js"><link rel="prefetch" href="/assets/js/67.aeba61a8.js"><link rel="prefetch" href="/assets/js/68.81e8ae85.js"><link rel="prefetch" href="/assets/js/69.fb8f7d5d.js"><link rel="prefetch" href="/assets/js/7.6689766d.js"><link rel="prefetch" href="/assets/js/70.f55dc26a.js"><link rel="prefetch" href="/assets/js/71.d310670d.js"><link rel="prefetch" href="/assets/js/72.d0b65202.js"><link rel="prefetch" href="/assets/js/73.fbee5211.js"><link rel="prefetch" href="/assets/js/74.952412ed.js"><link rel="prefetch" href="/assets/js/76.7b2a8f50.js"><link rel="prefetch" href="/assets/js/77.f75ad0d8.js"><link rel="prefetch" href="/assets/js/8.1f4717e3.js"><link rel="prefetch" href="/assets/js/9.a70f9ef6.js">
    <link rel="stylesheet" href="/assets/css/0.styles.144ea653.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">My vuepress</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/md/java/base/Base.html" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/md/about/并发编程.html" class="nav-link">
  关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/md/java/base/Base.html" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/md/about/并发编程.html" class="nav-link">
  关于
</a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><p>群聊是多人社交的基本诉求，一个群友在群内发了一条消息，期望做到：
(1)在线的群友能第一时间收到消息；
(2)离线的群友能在登陆后收到消息；
群消息的实时性、可达性、离线消息的复杂度，要远高于单对单消息。</p> <p>常见的群消息流程如何？
群业务的核心数据结构有两个。</p> <p>群成员表：
t_group_users(group_id, user_id)
画外音：用来描述一个群里有多少成员。</p> <p>群离线消息表：
t_offine_msgs(user_id, group_id, sender_id,time, msg_id, msg_detail)
画外音：用来描述一个群成员的离线消息。</p> <p>业务场景举例：
(1)假设一个群中有x,A,B,C,D共5个成员，成员x发了一个消息；
(2)成员A与B在线，期望实时收到消息；
(3)成员C与D离线，期望未来拉取到离线消息；
<img src="/images/ref/%E7%BE%A4%E8%81%8A0.jpg" alt="Alt text"></p> <p>典型群消息投递流程，如图步骤1-4所述：
步骤1：群消息发送者x向server发出群消息；
步骤2：server去db中查询群中有多少用户(x,A,B,C,D)；
步骤3：server去cache中查询这些用户的在线状态；
步骤4：对于群中在线的用户A与B，群消息server进行实时推送；
步骤5：对于群中离线的用户C与D，群消息server进行离线存储；
<img src="/images/ref/%E7%BE%A4%E8%81%8A1.png" alt="Alt text"></p> <p>典型的群离线消息拉取流程，如图步骤1-3所述：
步骤1：离线消息拉取者C向server拉取群离线消息；
步骤2：server从db中拉取离线消息并返回群用户C；
步骤3：server从db中删除群用户C的群离线消息；</p> <p>那么，问题来了！对于同一份群消息的内容，多个离线用户似乎要存储很多份。假设群中有200个用户离线，离线消息则冗余了200份，这极大的增加了数据库的存储压力。</p> <p>如何优化，减少消息冗余量？
为了减少离线消息的冗余度，增加一个群消息表，用来存储所有群消息的内容，离线消息表只存储用户的群离线消息msg_id，就能大大的降低数据库的冗余存储量。</p> <p>群消息表：
t_group_msgs(group_id, sender_id, time,msg_id, msg_detail)
画外音：用来存储一个群中所有的消息内容。</p> <p>群离线消息表，需要进行优化：
t_offine_msgs(user_id, group_id, msg_id)
画外音：优化后只存储msg_id。
<img src="/images/ref/%E7%BE%A4%E8%81%8A2.jpg" alt="Alt text"></p> <p>这样优化后，群在线消息发送就做了一些修改：
步骤3：每次发送在线群消息之前，要先存储群消息的内容；
步骤6：每次存储离线消息时，只存储msg_id，而不用为每个用户存储msg_detail；
<img src="/images/ref/%E7%BE%A4%E8%81%8A3.jpg" alt="Alt text"></p> <p>拉取离线消息时也做了响应的修改：
步骤1：先拉取所有的离线消息msg_id；
步骤3：再根据msg_id拉取msg_detail；
步骤5：删除离线msg_id；</p> <p>优化后的流程，能保证消息的可达性么？例如：
（1）在线消息的投递可能出现消息丢失，例如服务器重启，路由器丢包，客户端crash；
（2）离线消息的拉取也可能出现消息丢失，原因同上；
画外音：单对单消息的可靠投递一样，是通过加入应用层的ACK实现的，群消息呢？</p> <p><img src="/images/ref/%E7%BE%A4%E8%81%8A4.jpg" alt="Alt text"></p> <p>应用层ACK优化后，群在线消息发送又发生了一些变化：
步骤3：在消息msg_detail存储到群消息表后，不管用户是否在线，都先将msg_id存储到离线消息表里；
步骤6：在线的用户A和B收到群消息后，需要增加一个应用层ACK，来标识消息到达；
步骤7：在线的用户A和B在应用层ACK后，将他们的离线消息msg_id删除掉；
<img src="/images/ref/%E7%BE%A4%E8%81%8A5.png" alt="Alt text"></p> <p>对应到群离线消息的拉取也一样：
步骤1：先拉取msg_id；
步骤3：再拉取msg_detail；
步骤5：最后应用层ACK；
步骤6：server收到应用层ACK才能删除离线消息表里的msg_id；</p> <p>如果拉取了消息，却没来得及应用层ACK，会收到重复的消息么？
似乎会，但可以在客户端去重，对于重复的msg_id，对用户不展现，从而不影响用户体验。</p> <p>对于离线的每一条消息，虽然只存储了msg_id，但是每个用户的每一条离线消息都将在数据库中保存一条记录，有没有办法减少离线消息的记录数呢？</p> <p>对于一个群用户，在ta登出后的离线期间内，肯定是所有的群消息都没有收到的，完全不用对所有的每一条离线消息存储一个离线msg_id，而只需要存储最近一条拉取到的离线消息的time（或者msg_id），下次登录时拉取在那之后的所有群消息即可，而完全没有必要存储每个人未拉取到的离线消息msg_id。</p> <p>群成员表，增加一个属性：
t_group_users(group_id, user_id, last_ack_msg_id)
画外音：用来描述一个群里有多少成员，以及每个成员最后一条ack的群消息的msg_id（或者time）。</p> <p>群消息表，不变：
t_group_msgs(group_id, sender_id, time,msg_id, msg_detail)
画外音：还是用来存储一个群中所有的消息内容。</p> <p>群离线消息表：不再需要。
<img src="/images/ref/%E7%BE%A4%E8%81%8A6.jpg" alt="Alt text"></p> <p>离线消息表优化后，群在线消息的投递流程：
步骤3：在消息msg_detail存储到群消息表后，不再需要操作离线消息表（优化前需要将msg_id插入离线消息表）；
步骤7：在线的用户A和B在应用层ACK后，将last_ack_msg_id更新即可（优化前需要将msg_id从离线消息表删除）；</p> <p><img src="/images/ref/%E7%BE%A4%E8%81%8A7.png" alt="Alt text"></p> <p>群离线消息的拉取流程也类似：
步骤1：拉取离线消息；
步骤3：ACK离线消息；
步骤4：更新last_ack_msg_id；</p> <p>加入ACK机制，保证群消息的可靠投递只会，假设1个群有500个用户，“每条”群消息都会变为500个应用层ACK，似乎会对服务器造成巨大的冲击。有没有办法减少ACK请求量呢？</p> <p>批量ACK，是一种常见的，降低请求量的方式。
如果每条群消息都ACK，确实会给服务器造成巨大的冲击，为了减少ACK请求量，可以批量ACK，批量ACK的方式又有两种方式：
(1)每收到N条群消息ACK一次，这样请求量就降低为原来的1/N了；
(2)每隔时间间隔T进行一次群消息ACK，也能达到类似的效果；</p> <p>批量ACK有可能导致新的问题：如果还没有来得及ACK群消息，用户就退出了，这样下次登录似乎会拉取到重复的离线消息，怎么办？
客户端按照msg_id去重，不对用户展现，就保证良好的用户体验。</p> <p>群离线消息过多，拉取过慢，怎么办？
分页拉取（按需拉取），细节就不再展开了，都是常见的优化方案。</p> <p>总结
群消息还是非常有意思的，做个简单总结：
(1)不管是群在线消息，还是群离线消息，应用层的ACK是可达性的保障；
(2)群消息只存一份，不用为每个用户存储离线群msg_id，只需存储一个最近ack的群消息id/time；
(3)为了减少消息风暴，可以批量ACK；
(4)如果收到重复消息，需要msg_id去重，让用户无感知；
(5)离线消息过多，可以分页拉取（按需拉取）优化；</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/realpdai/tech-arch-doc/edit/master/md/待整理/群聊设计.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2020-6-26 17:00:44</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.afcd353c.js" defer></script><script src="/assets/js/2.6527dd7c.js" defer></script><script src="/assets/js/75.2f6086aa.js" defer></script>
  </body>
</html>
