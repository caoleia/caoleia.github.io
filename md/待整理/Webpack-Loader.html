<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Webpack-Loader | My vuepress</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/favicon.ico">
    <script src="https://hm.baidu.com/hm.js?xxxxxxxxxxx"></script>
    <meta name="description" content="Todo">
    <meta name="robots" content="all">
    <meta name="author" content="pdai">
    <meta name="keywords" content="Java 全栈知识体系, java体系, java知识体系, java框架,java详解,java学习路线,java spring, java面试, 知识体系, java技术体系, java编程, java编程指南,java开发体系, java开发,java教程,java,java数据结构, 算法, 开发基础">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="preload" href="/assets/css/0.styles.144ea653.css" as="style"><link rel="preload" href="/assets/js/app.afcd353c.js" as="script"><link rel="preload" href="/assets/js/2.6527dd7c.js" as="script"><link rel="preload" href="/assets/js/69.fb8f7d5d.js" as="script"><link rel="prefetch" href="/assets/js/10.b8af9589.js"><link rel="prefetch" href="/assets/js/11.da070787.js"><link rel="prefetch" href="/assets/js/12.e8c2df3f.js"><link rel="prefetch" href="/assets/js/13.13f8690b.js"><link rel="prefetch" href="/assets/js/14.97d7a7c6.js"><link rel="prefetch" href="/assets/js/15.ca82dd18.js"><link rel="prefetch" href="/assets/js/16.0795663b.js"><link rel="prefetch" href="/assets/js/17.9f529ede.js"><link rel="prefetch" href="/assets/js/18.aa494d1d.js"><link rel="prefetch" href="/assets/js/19.c5e368a6.js"><link rel="prefetch" href="/assets/js/20.8486962d.js"><link rel="prefetch" href="/assets/js/21.1a96e733.js"><link rel="prefetch" href="/assets/js/22.5b4929c3.js"><link rel="prefetch" href="/assets/js/23.7bc228ce.js"><link rel="prefetch" href="/assets/js/24.63116242.js"><link rel="prefetch" href="/assets/js/25.e9163e8b.js"><link rel="prefetch" href="/assets/js/26.31132baf.js"><link rel="prefetch" href="/assets/js/27.728265df.js"><link rel="prefetch" href="/assets/js/28.4cb93316.js"><link rel="prefetch" href="/assets/js/29.30a99cb0.js"><link rel="prefetch" href="/assets/js/3.e3c760c5.js"><link rel="prefetch" href="/assets/js/30.39c64819.js"><link rel="prefetch" href="/assets/js/31.78e9d272.js"><link rel="prefetch" href="/assets/js/32.e71f2609.js"><link rel="prefetch" href="/assets/js/33.b182a570.js"><link rel="prefetch" href="/assets/js/34.d919b2af.js"><link rel="prefetch" href="/assets/js/35.e2cdb183.js"><link rel="prefetch" href="/assets/js/36.759e107d.js"><link rel="prefetch" href="/assets/js/37.a0ccb526.js"><link rel="prefetch" href="/assets/js/38.8f8ec90d.js"><link rel="prefetch" href="/assets/js/39.bcb56569.js"><link rel="prefetch" href="/assets/js/4.e1e5a770.js"><link rel="prefetch" href="/assets/js/40.cb9e68d1.js"><link rel="prefetch" href="/assets/js/41.f7324d34.js"><link rel="prefetch" href="/assets/js/42.fbc4875e.js"><link rel="prefetch" href="/assets/js/43.602efb90.js"><link rel="prefetch" href="/assets/js/44.5cdea7dd.js"><link rel="prefetch" href="/assets/js/45.08b55f16.js"><link rel="prefetch" href="/assets/js/46.89b660d7.js"><link rel="prefetch" href="/assets/js/47.8041c4a7.js"><link rel="prefetch" href="/assets/js/48.54a6e067.js"><link rel="prefetch" href="/assets/js/49.63fc5fb5.js"><link rel="prefetch" href="/assets/js/5.b9a4a83e.js"><link rel="prefetch" href="/assets/js/50.defc28ad.js"><link rel="prefetch" href="/assets/js/51.01fa48a2.js"><link rel="prefetch" href="/assets/js/52.04cb5e30.js"><link rel="prefetch" href="/assets/js/53.b04e4c27.js"><link rel="prefetch" href="/assets/js/54.a99c8dca.js"><link rel="prefetch" href="/assets/js/55.f15500bf.js"><link rel="prefetch" href="/assets/js/56.c9d0f497.js"><link rel="prefetch" href="/assets/js/57.eb7e4183.js"><link rel="prefetch" href="/assets/js/58.4a5207ff.js"><link rel="prefetch" href="/assets/js/59.8620aeb6.js"><link rel="prefetch" href="/assets/js/6.ddfdb723.js"><link rel="prefetch" href="/assets/js/60.a1b1dae5.js"><link rel="prefetch" href="/assets/js/61.e6ec84e2.js"><link rel="prefetch" href="/assets/js/62.8703dde9.js"><link rel="prefetch" href="/assets/js/63.76d6c8fe.js"><link rel="prefetch" href="/assets/js/64.1abf1796.js"><link rel="prefetch" href="/assets/js/65.7430076b.js"><link rel="prefetch" href="/assets/js/66.9ca1a22b.js"><link rel="prefetch" href="/assets/js/67.aeba61a8.js"><link rel="prefetch" href="/assets/js/68.81e8ae85.js"><link rel="prefetch" href="/assets/js/7.6689766d.js"><link rel="prefetch" href="/assets/js/70.f55dc26a.js"><link rel="prefetch" href="/assets/js/71.d310670d.js"><link rel="prefetch" href="/assets/js/72.d0b65202.js"><link rel="prefetch" href="/assets/js/73.fbee5211.js"><link rel="prefetch" href="/assets/js/74.952412ed.js"><link rel="prefetch" href="/assets/js/75.2f6086aa.js"><link rel="prefetch" href="/assets/js/76.7b2a8f50.js"><link rel="prefetch" href="/assets/js/77.f75ad0d8.js"><link rel="prefetch" href="/assets/js/8.1f4717e3.js"><link rel="prefetch" href="/assets/js/9.a70f9ef6.js">
    <link rel="stylesheet" href="/assets/css/0.styles.144ea653.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">My vuepress</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/md/java/base/Base.html" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/md/about/并发编程.html" class="nav-link">
  关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/md/java/base/Base.html" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/md/about/并发编程.html" class="nav-link">
  关于
</a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="编写loader"><a href="#编写loader" class="header-anchor">#</a> 编写Loader</h1> <p>处理SCSS为例：</p> <ol><li>先将scss源代码提交给sass-loader ,将scss 转换成CSS</li> <li>将sass-loader 输出的css 提交给css-loader 处理，找出css 中依赖的资源、压缩css等</li> <li>将css-loader 输出的css 提交给style-loader 处理，转换成通过脚本加载的JavaScript代码</li></ol> <p>一个Loader 的职责是单一的， 只需要完成一种转换。如果一个源文件需要经历多步转换才正常使用，就通过多个Loader去转换。
在调用多个Loader去转换一个文件时，每个Loader 都会链式地顺序执行，所以在开发一个Loader时，请保持其职责的单一性，我们只需关心输入和输出。</p> <p>Webpack 是运行在Node . 上的，一个L oader 其实就是一个Node.js 模块，这个模块需要导出一个函数。
这个导出的函数的工作就是获得处理前的原内容，对原内容执行处理后，返回处理后的内容。</p> <p>一个最简单的Loader的源码如下：</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//source 为compiler 传递给Loader 的一个文件的原内容</span>
    <span class="token comment">//该函数需要返回处理后的内容，这里为了简单起见，直接将原内容返回了，相当于该Loader 没有做任何转换</span>
    <span class="token keyword">return</span> source <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>由于Loader 运行在Node.js 中，所以我们可以调用任意Node.js 自带的API ，或者安装第三方模块进行调用：</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> sass<span class="token operator">=</span> <span class="token function">require</span> <span class="token punctuation">(</span><span class="token string">'node-sass'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">sass</span> <span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="webpack提供给loader的api"><a href="#webpack提供给loader的api" class="header-anchor">#</a> Webpack提供给Loader的API</h2> <h3 id="传入options"><a href="#传入options" class="header-anchor">#</a> 传入options</h3> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> loaderUtils <span class="token operator">=</span><span class="token function">require</span> <span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//获取用户为当前Loader 传入的options</span>
    <span class="token keyword">const</span> options<span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> source<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="返回其他结果"><a href="#返回其他结果" class="header-anchor">#</a> 返回其他结果</h3> <p>以用babel-loader 转换ES6 代码为例，它还需要输出转换后的ES5 代码对应的SourceMap ，以方便调试源码。为了将Source Map 也一起随着ES5 代码返回给Webpack ，还可以
这样写：</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//通过this.callback 告诉Webpack 返回的结果</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> source<span class="token punctuation">,</span> sourceMaps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//当我们使用this.callbac k 返回内容时，该Loader 必须返回undefined,</span>
    <span class="token comment">//以让Webpack 知道该Loader 返回的结果在this.callback 中，而不是retur n 中</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>其中的this.callback 是Webpack 向Loader注入的API ，以方便Loader 和Webpack之间通信。this.callback 的详细使用方法如下：</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span>
    <span class="token comment">//当无法转换原内容时，为Webpa ck 返回一个Error</span>
    err<span class="token operator">:</span> Error <span class="token constant">I</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token comment">//原内容转换后的内容</span>
    content<span class="token operator">:</span> string <span class="token constant">I</span> Buffer<span class="token punctuation">,</span>
    <span class="token comment">//用于通过转换后的内容得出原内容的Source Map ，以方便调试</span>
    sourceMap<span class="token operator">?</span><span class="token operator">:</span> SourceMap<span class="token punctuation">,</span>
    <span class="token comment">//如果本次转换为原内容生成了AST 语法树，则可以将这个AST 返回，</span>
    <span class="token comment">//以方便之后需要AST 的Loader 复用该AST ，避免重复生成AST ，提升性能</span>
    abstractSyntaxTree<span class="token operator">?</span><span class="token operator">:</span> <span class="token constant">AST</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>Source Map 的生成很耗时，通常在开发环境下才会生成Source Map ，在其他环境下不用生成，以加速构建。
因此， Webpack 为Loader 提供了this. sourceMap API 去告诉Loader在当前构建环境下用户是否需要Source Map。</p> <h3 id="其他api"><a href="#其他api" class="header-anchor">#</a> 其他API</h3> <ol><li>this.context： 当前处理的文件所在的目录，假如当前Loader 处理的文件是/src/main .js ，则this.context 等于／src 。</li> <li>this.resource ：当前处理的文件的完整请求路径，包括querystring ，例如/src/main.js?name=l 。</li> <li>this.resourcePath ：当前处理的文件的路径，例如/src/main.js 。</li> <li>this.resourceQuery ：当前处理的文件的querystring</li> <li>this.target ：等于Webpack 配置中的Target</li> <li>this.loadModule ：当Loader 在处理一个文件时，如果依赖其他文件的处理结果才能得出当前文件的结果
就可以通过this.loadModule(request: string,callback : function (err, source, sourceMap, module ))去获取request</li> <li>this.resolve ：像require语句一样获得指定文件的完整路径，使用方法为
resolve(context : string , request: string, callback : function(err, result: string ))。</li> <li>this.addDependency ：为当前处理的文件添加其依赖的文件，以便其依赖的文件发生发生变化时，重新调用Loader处理该文件。
使用方法为addDependency (file:string ）。</li> <li>this.addContextDependency ：和addDependency 类似，但addContextDependency 是将整个目录加入当前正在处理的文件的依赖中。
使用方法为addContextDependency (directory : string ）。</li> <li>this.clearDependencies ：清除当前正在处理的文件的所有依赖，使用方法为clearDependencies()。</li> <li>this.emitFile ：输出一个文件，使用方法为emitFile(name : string ,content: Buffer | string , sourceMap: { ... })。</li></ol> <h2 id="加载本地loader"><a href="#加载本地loader" class="header-anchor">#</a> 加载本地Loader</h2> <ol><li>Npm link
Npm link 专门用于开发和调试本地的Npm 模块，能做到在不发布模块的情况下， 将本地的一个正在开发的模块的源码链接到项目的node modules 目录下，让项目可以直接使用本地的Npm 模块。</li></ol> <p>完成Npm link 的步骤如下：</p> <ol><li>确保正在开发的本地Npm 模块（也就是正在开发的Loader ） 的package. json 己经正确配置好：</li> <li>在本地的Npm 模块根目录下执行npm link ，将本地模块注册到全局：</li> <li>在项目根目录下执行npm link loader-name ，将第2 步注册到全局的本地Npm模块链接到项目的node moduels 下，其中的loader-name 是指在第1 步的package.json 文件中配置的模块名称。</li></ol> <p>链接好Loader 到项目后我们就可以像使用一个真正的Npm 模块一样使用本地的Loader了。</p> <ol start="2"><li>Resolveloader
ResolveLoader 用于配置Webpack 如何寻找Loader ，它在默认情况下只会去node_modules 目录下寻找。
为了让Webpack 加载放在本地项目中的Loader,需要修改resolveLoader .m odules 。
假如本地项目中的Loader在项目目录的./loaders/loader-name 下， 则需要如下配置：</li></ol> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code>module <span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    resolveLoader<span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token comment">//去哪些目录下寻找Loader ，有先后顺序之分</span>
    modules <span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'node modules'</span><span class="token punctuation">,</span><span class="token string">'./loaders/'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>加上以上配置后， Webpack 会先去node_modules 项目下寻找Loader ，如果找不到，则再去./loaders/目录下寻找。</p> <h2 id="实战"><a href="#实战" class="header-anchor">#</a> 实战</h2> <p>编写一个Loader comment-require-loader作用是将JavaScript中的注释语法</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// @require '.. lsty le li ndex.css'</span>
转换成：
<span class="token function">require</span> <span class="token punctuation">(</span><span class="token string">'.. lstylelindex.css'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>该Loader 的实现非常简单，完整代码如下：</p> <div class="language-javaScript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//使用正则表达式将// @require '../style/lindex.css'转换成 require ('..style/lindex.css');</span>
    <span class="token keyword">return</span> source<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token operator">/</span><span class="token punctuation">(</span>\<span class="token operator">/</span><span class="token regex">/ *@require) +((''').+(''')).*/</span><span class="token punctuation">,</span><span class="token string">'require($2);'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">replace</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/realpdai/tech-arch-doc/edit/master/md/待整理/Webpack-Loader.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2020-6-26 17:00:44</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.afcd353c.js" defer></script><script src="/assets/js/2.6527dd7c.js" defer></script><script src="/assets/js/69.fb8f7d5d.js" defer></script>
  </body>
</html>
